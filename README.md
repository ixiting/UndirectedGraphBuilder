UndirectedGraphBuilder — плагин, который позволяет создавать простой неориентированный граф поверх чертежа: вершины (круги/треугольники) и рёбра (полилинии). Плагин хранит метаданные (UID, метки, связи) в XData сущностей, чтобы граф можно было восстановить при открытии чертежа.

Основные команды и функции

- UGB_VERTEX: Создать или выбрать вершину. Стиль ограничен: "Синий круг" или "Красный треугольник". Метки не запрашиваются.
- UGB_BUILD: Режим поочерёдного построения вершин с возможностью соединения.
- UGB_EDIT: Меню редактирования (добавить вершину, изменить цвет/форму, удалить).
- UGB_PATH: Поиск кратчайшего пути между двумя вершинами и подсветка соответствующих рёбер.
- UGB_REFRESH: Пересчитать геометрию всех рёбер (используется при изменении положения вершин).
- UGB_DUMPSTATE: Вывести текущее состояние графа (вершины, рёбра) в окно команды.
- UGB_LIST_XDATA: Перечислить XData всех сущностей в ModelSpace (диагностика).
- UGB_ATTACH: Подписаться на события базы данных текущего документа (append/erase/modify).
- UGB_ENSUREUID: Прописать UID в XData для вершин, у которых он отсутствует.

Ключевые компоненты кода

- `CadCommands/Cmd.cs` — основной модуль с командами, логикой создания сущностей, восстановлением графа из XData, обработчиками событий базы данных и т.д.
- `CadObjects/GraphVertex.cs` — DTO для вершины: содержит `DrawingObjectId`, `Center`, `Uid`, `Label`, `IsTriangle`, `AttachedEdgeIds`, `IsErased`.
- `CadObjects/GraphEdge.cs` — DTO для ребра: содержит `DrawingObjectId`, `StartVertexId`, `EndVertexId`, `IntermediatePoints`.
- `Utils/GeometryUtils.cs` — вспомогательные геометрические функции (радиус вершины, симметричные точки треугольника и т.п.).

Как плагин восстанавливает граф

1. При загрузке/активации документа вызывается `RestoreGraphFromDrawing`.
2. Функция сканирует ModelSpace, читает XData сущностей и восстанавливает вершины (по APP_NAME/UID) и рёбра (по APP_NAME c хэндлами вершин).
3. После восстановления подписывается на события базы (ObjectErased/ObjectAppended/ObjectModified) для динамического обновления модели.

Диагностика и отладка

- `UGB_LIST_XDATA` помогает увидеть, какие XData реально содержатся в сущностях и почему восстановление может проваливаться.
- `UGB_DUMPSTATE` показывает текущее состояние в памяти плагина.


